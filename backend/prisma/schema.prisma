// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ====================== MODELS ======================

model Owner {
  owner_id        Int       @id @default(autoincrement())
  owner_name      String    @db.VarChar(100)
  contact_number  String    @db.VarChar(20)
  vehicles        Vehicle[] // ✅ One owner can have multiple vehicles
}

model Vehicle {
  vehicle_id               Int                @id @default(autoincrement())
  vehicle_number           String             @unique @db.VarChar(50)
  name                     String             @db.VarChar(100)
  type                     VehicleType
  rent_cost_daily          Decimal            @db.Decimal(10,2)
  fuel_id                  Int
  ac_type                  AcType
  owner_cost_monthly       Decimal            @db.Decimal(10,2)
  license_image            Bytes?
  insurance_card_image     Bytes?
  eco_test_image           Bytes?
  book_image               Bytes?
  license_expiry_date      DateTime?
  insurance_expiry_date    DateTime?
  eco_test_expiry_date     DateTime?
  vehicle_fuel_efficiency  Decimal?           @db.Decimal(10,2)
  image                    Bytes?
  vehicle_availability     AvailabilityStatus @default(Yes)
  meter_number             Int?
  last_service_meter_number Int?
  owner_id                 Int?               // ✅ Each vehicle can have one owner (optional)
  owner                    Owner?             @relation(fields: [owner_id], references: [owner_id])
  mileage_costs            Mileage_Cost[]
  gps                      GPS[]
  trips                    Trip[]
  fuel                     Fuel               @relation(fields: [fuel_id], references: [fuel_id])
  vehicle_other_costs      Vehicle_Other_Cost[]
  bill_uploads             Bill_Upload[]
}

model Mileage_Cost {
  mileage_cost_id        Int      @id @default(autoincrement())
  vehicle_id             Int
  mileage_cost           Decimal  @db.Decimal(10,2)
  mileage_cost_additional Decimal @db.Decimal(10,2)
  vehicle                Vehicle  @relation(fields: [vehicle_id], references: [vehicle_id])
}

model Driver {
  driver_id         Int      @id @default(autoincrement())
  name              String   @db.VarChar(100)
  phone_number      String   @db.VarChar(20)
  driver_charges    Decimal  @db.Decimal(10,2)
  nic               String   @db.VarChar(20) @unique
  image             Bytes?
  age               Int
  license_number    String   @db.VarChar(50)
  license_expiry_date DateTime
  admin             Admin[]
  trips             Trip[]
  bill_uploads      Bill_Upload[]
}

model Admin {
  admin_id     Int      @id @default(autoincrement())
  driver_id    Int?
  customer_id  Int?
  email        String   @unique @db.VarChar(100)
  password     String   @db.VarChar(255)
  role         Role
  driver       Driver?  @relation(fields: [driver_id], references: [driver_id])
  customer     Customer? @relation(fields: [customer_id], references: [customer_id])
}

model Fuel {
  fuel_id   Int      @id @default(autoincrement())
  type      FuelType
  cost      Decimal  @db.Decimal(10,2)
  vehicles  Vehicle[]
}

model GPS {
  gps_id       Int      @id @default(autoincrement())
  vehicle_id   Int
  tracker_id   String   @db.VarChar(100)
  recorded_at  DateTime
  latitude     Decimal  @db.Decimal(10,6)
  longitude    Decimal  @db.Decimal(10,6)
  vehicle      Vehicle  @relation(fields: [vehicle_id], references: [vehicle_id])
}

model Customer {
  customer_id      Int      @id @default(autoincrement())
  nic              String   @db.VarChar(20)
  nic_photo_front  Bytes?
  nic_photo_back   Bytes?
  name             String   @db.VarChar(100)
  phone_number     String   @db.VarChar(20)
  email            String   @db.VarChar(100) @unique
  trips            Trip[]
  admin            Admin[]
}

model Trip {
  trip_id                    Int        @id @default(autoincrement())
  map_id                     Int?
  customer_id                Int
  vehicle_id                 Int
  from_location              String     @db.VarChar(100)
  to_location                String     @db.VarChar(100)
  up_down                    TripDirection
  estimated_distance         Decimal?   @db.Decimal(10,2)
  actual_distance            Decimal?   @db.Decimal(10,2)
  estimated_days             Int?
  actual_days                Int?
  leaving_datetime           DateTime
  estimated_return_datetime  DateTime?
  actual_return_datetime     DateTime?
  driver_required            YesNo
  driver_id                  Int?
  estimated_cost             Decimal?   @db.Decimal(10,2)
  actual_cost                Decimal?   @db.Decimal(10,2)
  mileage_cost               Decimal?   @db.Decimal(10,2)
  fuel_required              YesNo
  num_passengers             Int?
  discount                   Decimal?   @db.Decimal(10,2)
  damage_cost                Decimal?   @db.Decimal(10,2)
  payment_amount             Decimal?   @db.Decimal(10,2)
  advance_payment            Decimal?   @db.Decimal(10,2)
  start_meter                Int?
  end_meter                  Int?
  total_estimated_cost       Decimal?   @db.Decimal(10,2)
  total_actual_cost          Decimal?   @db.Decimal(10,2)
  payment_status             PaymentStatus
  trip_status                TripStatus
  additional_mileage_cost    Decimal?   @db.Decimal(10,2)
  profit                     Decimal?   @db.Decimal(10,2)  // per km after limit
  fuel_cost                  Decimal?   @db.Decimal(10,2)  // total estimated fuel cost
  driver_cost                Decimal?   @db.Decimal(10,2)  // driver charge
  vehicle_rent_daily         Decimal?   @db.Decimal(10,2)
  fuel_efficiency            Decimal? @db.Decimal(10,2)   // km per liter used at the time of trip
  created_at                 DateTime   @default(now())
  customer                   Customer   @relation(fields: [customer_id], references: [customer_id])
  vehicle                    Vehicle    @relation(fields: [vehicle_id], references: [vehicle_id])
  driver                     Driver?    @relation(fields: [driver_id], references: [driver_id])
  map                        Map[]
  payments                   Payment[]
  other_trip_costs            Other_Trip_Cost[]
}

model Map {
  map_id        Int     @id @default(autoincrement())
  trip_id       Int
  location_name String  @db.VarChar(255) // e.g., "Colombo"
  latitude      Decimal @db.Decimal(10,6)
  longitude     Decimal @db.Decimal(10,6)
  sequence      Int     // order of the location in the trip
  trip          Trip    @relation(fields: [trip_id], references: [trip_id])

  @@index([trip_id, sequence])
}

model Payment {
  payment_id   Int      @id @default(autoincrement())
  trip_id      Int
  amount       Decimal  @db.Decimal(10,2)
  payment_date DateTime
  trip         Trip     @relation(fields: [trip_id], references: [trip_id])
}

model Vehicle_Other_Cost {
  vehicle_other_cost_id Int       @id @default(autoincrement())
  vehicle_id            Int
  date                  DateTime
  cost                  Decimal   @db.Decimal(10,2)
  cost_type             VehicleCostType
  vehicle               Vehicle   @relation(fields: [vehicle_id], references: [vehicle_id])

  // One-to-one relation to Bill_Upload
  bill                  Bill_Upload? @relation(fields: [bill_id], references: [bill_id])
  bill_id               Int?         @unique
}

model Bill_Upload {
  bill_id          Int      @id @default(autoincrement())
  vehicle_id       Int?
  driver_id        Int?
  bill_image       String?
  bill_type        BillType
  bill_date        DateTime
  bill_status      BillStatus @default(pending)

  vehicle          Vehicle? @relation(fields: [vehicle_id], references: [vehicle_id])
  driver           Driver?  @relation(fields: [driver_id], references: [driver_id])
  vehicle_other_cost Vehicle_Other_Cost?  // Optional inverse relation
}


model Other_Trip_Cost {
  trip_other_cost_id Int          @id @default(autoincrement())
  trip_id            Int
  cost_type          TripCostType
  cost_amount        Decimal      @db.Decimal(10,2)
  trip               Trip         @relation(fields: [trip_id], references: [trip_id])
}


model AuditLog {
  audit_id      Int        @id @default(autoincrement())
  user_id       Int?                       // Reference to the admin/driver/customer
  user_role     Role?                      // Role of the user
  action_type   ActionType                 // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  entity_name   String       @db.VarChar(100) // e.g. "Trip", "Vehicle", "Owner"
  entity_id     Int?                       // ID of the affected entity
  old_data      Json?                      // Snapshot of data before change
  new_data      Json?                      // Snapshot of data after change
  description   String?     @db.Text        // Human-readable description of the event
  ip_address    String?     @db.VarChar(45) // Optional: for security tracking
  user_agent    String?     @db.VarChar(255)
  created_at    DateTime    @default(now()) // Timestamp of the action

  // Optional relation to Admin (if you want a foreign key link)
}

// ====================== ENUMS ======================
enum BillStatus {
  pending
  completed
}

enum ActionType {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  VIEW
}

enum VehicleType {
  Car
  Van
  Bus
  Bike
}

enum AcType {
  AC
  Non_AC
}

enum AvailabilityStatus {
  Yes
  No
}

enum Role {
  Admin
  SuperAdmin
  Driver
  Customer
}

enum FuelType {
  SuperDisel
  Diesel
  Octane92
  Octane95
  Kerosene
}

enum TripDirection {
  Up
  Down
  Both
}

enum YesNo {
  Yes
  No
}

enum PaymentStatus {
  Paid
  Partially_Paid
  Unpaid
}

enum TripStatus {
  Pending
  Ongoing
  Ended
  Completed
  Cancelled
}

enum VehicleCostType {
  Lease_Cost
  Service_Cost
  Repairs_Cost
  Insurance_Amount
  Revenue_License
  Eco_Test_Cost
  Fuel_Cost
}

enum BillType {
  Lease_Cost
  Service_Cost
  Repairs_Cost
  Insurance_Amount
  Revenue_License
  Eco_Test_Cost
  Fuel_Cost
}

enum TripCostType {
  Meal
  Accommodation
  Driver_Accommodation
  Driver_Meal
  Other
}
